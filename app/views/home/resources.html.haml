- content_for :javascripts do
  = javascript_include_tag "leaflet"
  = javascript_include_tag "leaflet.label"
  = javascript_include_tag "jquery-ui-slider.min"
  = javascript_include_tag "jquery.address.min"
  = javascript_include_tag "jenks"

  :javascript
    $(window).resize(function () {
      var h = $(window).height(),
        offsetTop = 100; // Calculate the top offset

      $('#map').css('height', (h - offsetTop));
    }).resize();

    var map = L.map('map').setView([41.8781136, -87.66677856445312], 11);

    var mapbox = L.tileLayer('https://{s}.tiles.mapbox.com/v3/smartchicagocollaborative.heooddo8/{z}/{x}/{y}.png', {
        attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
    }).addTo(map);
    map.attributionControl.setPrefix('');

    var geojsonFeature = #{@display_geojson};
    var geojson;
    var allLayers = [];

    // control that shows info on hover
    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
    }

    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
        }
    }


    geojson = L.geoJson(geojsonFeature, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map);

    for(layer in allLayers){
        var props = allLayers[layer].feature.properties;
        allLayers[layer].bindLabel( '<h4>' + props.name + '</h4>');
    }

    function style(feature) {
        return {
            fillColor: '#EE3F44',
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7
        };
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: linkToDetail
        });
        allLayers.push(layer);
    }

    function linkToDetail(e) {
        window.location = '/place/' + e.target.feature.properties.slug + '/resources';
    }

.row-fluid#map-page
  .span4
    - title 'Resources by neighborhood'
    %h3
      Resources by neighborhood

    %p
      Pick a neighborhood and find resources where you can improve your own health.

  .span8
    #map